<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Assinatura do Contrato | Help!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Nada de CSS novo aqui. Mantive apenas o HTML simples; se você já tem um CSS,
       ele continuará funcionando se estiver referenciado no <head>. -->
  <!-- Exemplo (opcional, mantenha se você já tinha): -->
  <!-- <link rel="stylesheet" href="./styles.css"> -->

  <!-- Carrego bibliotecas SÓ para garantir funcionalidade. Não alteram layout. -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
</head>
<body>
  <main>
    <header>
      <h1>Help! – Assinatura</h1>
      <p>Preencha seus dados e assine abaixo</p>
      <!-- Importante: link RELATIVO para funcionar no GitHub Pages -->
      <p><a href="./contract.html">Ler Contrato</a></p>
    </header>

    <!-- Tipo de contratante -->
    <section aria-labelledby="tipo">
      <h2 id="tipo" style="position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden;">Tipo de contratante</h2>
      <p><strong>Tipo de contratante</strong></p>
      <label><input type="radio" name="tipo" value="PF" checked> Pessoa Física (CPF)</label>
      <label><input type="radio" name="tipo" value="PJ"> Pessoa Jurídica (CNPJ)</label>
      <small>• Campos ajustam automaticamente</small>
    </section>

    <form id="form">
      <p>
        <label for="plano">Plano</label><br />
        <select id="plano" name="plano" required>
          <option value="Help! Start">Help! Start</option>
          <option value="Help! Prime">Help! Prime</option>
        </select>
      </p>

      <p>
        <label for="valor">Valor</label><br />
        <input id="valor" name="valor" placeholder="R$ 0,00" />
      </p>

      <!-- PF -->
      <div id="secPF">
        <p>
          <label for="cpf">CPF</label><br />
          <input id="cpf" name="cpf" inputmode="numeric" placeholder="000.000.000-00" />
        </p>
        <p>
          <label for="nome">Nome completo</label><br />
          <input id="nome" name="nome" placeholder="Seu nome" />
        </p>
      </div>

      <!-- PJ -->
      <div id="secPJ" style="display:none">
        <p>
          <label for="cnpj">CNPJ</label><br />
          <input id="cnpj" name="cnpj" inputmode="numeric" placeholder="00.000.000/0000-00" />
        </p>
        <p>
          <label for="razao">Razão Social</label><br />
          <input id="razao" name="razao" placeholder="SUA EMPRESA LTDA" />
        </p>
      </div>

      <p>
        <label for="responsavel">Responsável</label><br />
        <input id="responsavel" name="responsavel" placeholder="Nome do responsável" required />
      </p>

      <p>
        <label for="email">E-mail</label><br />
        <input id="email" name="email" type="email" placeholder="email@dominio.com" required />
      </p>

      <p>
        <label for="telefone">Telefone/WhatsApp</label><br />
        <input id="telefone" name="telefone" inputmode="tel" placeholder="(DDD) 90000-0000" required />
      </p>

      <p>
        <label for="assinaturaCanvas">Assinatura (desenhe abaixo)</label><br />
        <canvas id="assinaturaCanvas" height="160" style="border:1px dashed #999; width:100%; max-width:600px; background:#fff"></canvas><br />
        <button type="button" id="limparAssinatura">Limpar Assinatura</button>
      </p>

      <p>
        <label><input type="checkbox" id="aceite" required> Autorizo assinatura eletrônica e confirmo que li o contrato.</label>
      </p>

      <p>
        <button id="gerarPdfBtn" type="button">Gerar PDF + WhatsApp</button>
      </p>
      <div id="wa-fallback"></div>
    </form>
  </main>

  <!-- Apenas JS. Não altera visual; só faz o botão funcionar. -->
  <script>
  (function(){
    // ===== Helpers =====
    const $ = (s, c=document) => c.querySelector(s);
    const onlyDigits = s => String(s||'').replace(/\D+/g,'');
    const slug = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/gi,'-').replace(/(^-|-$)/g,'').toLowerCase();
    const hojeISO = () => new Date().toISOString().slice(0,10);
    const dataHoraBR = () => new Date().toLocaleString('pt-BR');

    // ===== PF/PJ Toggle (sem impacto visual, só exibe/esconde grupos) =====
    const radiosTipo = document.querySelectorAll('input[name="tipo"]');
    const secPF = $('#secPF'), secPJ = $('#secPJ'), cpf = $('#cpf'), nome = $('#nome'), cnpj = $('#cnpj'), razao = $('#razao');
    function toggleTipo(){
      const isPJ = (document.querySelector('input[name="tipo"]:checked')?.value || 'PF') === 'PJ';
      secPF.style.display = isPJ ? 'none' : '';
      secPJ.style.display = isPJ ? '' : 'none';
      if (cpf) cpf.required = !isPJ;
      if (nome) nome.required = !isPJ;
      if (cnpj) cnpj.required = isPJ;
      if (razao) razao.required = isPJ;
    }
    radiosTipo.forEach(r=>r.addEventListener('change', toggleTipo));
    toggleTipo();

    // ===== SignaturePad (sem mudar layout) =====
    const canvas = $('#assinaturaCanvas');
    let pad = null;
    if (window.SignaturePad && canvas) {
      pad = new window.SignaturePad(canvas, { backgroundColor: '#fff' });
      const resize = () => {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const wasEmpty = pad.isEmpty();
        canvas.width = canvas.clientWidth * ratio;
        canvas.height = canvas.clientHeight * ratio;
        const ctx = canvas.getContext('2d'); ctx.scale(ratio, ratio);
        if (wasEmpty) pad.clear();
      };
      window.addEventListener('resize', resize); resize();
      $('#limparAssinatura').addEventListener('click', ()=> pad && pad.clear());
    }

    // ===== Montagem do contrato (off-screen) =====
    function montarContrato(dados, assinaturaDataURL){
      const wrap = document.createElement('div');
      wrap.style.position = 'fixed';
      wrap.style.left = '-99999px';
      wrap.style.top = '0';
      wrap.style.pointerEvents = 'none';
      wrap.innerHTML = `
        <div id="contrato" style="font-family:Arial, Helvetica, sans-serif; color:#111; padding:24px; width:794px; background:#fff;">
          <h2 style="margin:0 0 8px">Contrato – ${dados.plano || '-'}</h2>
          <p style="margin:0 0 16px; color:#444">Data: ${hojeISO()}</p>

          <h3 style="margin:20px 0 8px">Dados do Contratante</h3>
          <table style="width:100%; border-collapse:collapse; font-size:14px">
            <tr><td style="padding:6px;border:1px solid #ddd">Tipo</td><td style="padding:6px;border:1px solid #ddd">${dados.tipo}</td></tr>
            <tr><td style="padding:6px;border:1px solid #dd
