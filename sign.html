<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assinatura do Contrato | Help! (hardened)</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --brand:#FFC107; --dark:#000; --light:#fff; --muted:#666; --border:#e5e5e5; --radius:14px; }
    *{box-sizing:border-box}
    body{margin:0;font:500 16px/1.6 'Open Sans',ui-sans-serif;color:#111;background:#fff}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:900px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:30px;height:30px;border-radius:8px;object-fit:cover}
    .grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    .full{grid-column:1/-1}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border)}
    label{font-size:13px;color:#444}
    .card{border:1px solid var(--border);padding:16px;border-radius:var(--radius)}
    .btn{border:0;background:linear-gradient(180deg,#FFD54F,#FFC107);color:#000;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;font-family:'Montserrat',sans-serif;box-shadow:0 6px 18px rgba(255,193,7,.25)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    canvas{display:block;width:100%;height:160px;background:#f8f8f8;border:1px dashed #ccc;border-radius:10px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.3s}
    .toast.show{opacity:1;transform:none}
    .confetti{position:fixed;inset:0;pointer-events:none;display:none}
    .inline{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:#666}
    .warn{background:#fff4e5;color:#5b3a00;border:1px solid #ffd8a8;padding:8px 10px;border-radius:10px;margin:8px 0;display:none}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">
      <img src="https://i.imgur.com/HzfBxmz.png" alt="Help!" loading="lazy">
      <div><strong style="font-family:'Montserrat',sans-serif">Help! – Assinatura</strong><div style="font-size:12px;color:#666">Preencha seus dados e assine abaixo</div></div>
    </div>
    <button class="btn" type="button" onclick="location.href='contract.html'">Ler Contrato</button>
  </div>
</header>

<main class="container">
  <form class="grid" id="formAssinatura">
    <!-- Tipo de Pessoa -->
    <div class="full">
      <label>Tipo de contratante</label>
      <div class="inline">
        <label><input type="radio" name="tipo" value="PF" id="rPF" checked> Pessoa Física (CPF)</label>
        <label><input type="radio" name="tipo" value="PJ" id="rPJ"> Pessoa Jurídica (CNPJ)</label>
        <span class="muted" id="hintTipo">• Campos ajustam automaticamente</span>
      </div>
    </div>

    <div>
      <label>Plano</label>
      <select id="fldPlano">
        <option>Help! Start</option>
        <option selected>Help! Prime</option>
      </select>
    </div>
    <div>
      <label>Valor</label>
      <input id="fldValor" value="R$ 2.000,00/mês" readonly />
    </div>

    <!-- Documento -->
    <div>
      <label id="lblDoc">CPF</label>
      <input id="fldDoc" required placeholder="000.000.000-00" />
    </div>

    <!-- Nome / Razão -->
    <div class="full">
      <label id="lblRazao">Nome completo</label>
      <input id="fldRazao" required placeholder="Seu nome completo"/>
    </div>

    <!-- Responsável (apenas PJ) -->
    <div id="grpResp">
      <label id="lblResp">Responsável</label>
      <input id="fldResp" placeholder="Nome do responsável legal"/>
    </div>

    <div>
      <label>E-mail</label>
      <input id="fldEmail" type="email" required placeholder="contato@empresa.com"/>
    </div>
    <div class="full">
      <label>Telefone/WhatsApp</label>
      <input id="fldFone" required placeholder="(00) 00000-0000" />
    </div>

    <!-- Assinatura -->
    <div class="full card">
      <label>Assinatura (desenhe abaixo)</label>
      <div id="sigWarn" class="warn">Não foi possível carregar a biblioteca de assinatura. Verifique bloqueadores de conteúdo e conexão. Você ainda poderá gerar o PDF, mas a assinatura é obrigatória.</div>
      <canvas id="sigCanvas"></canvas>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" type="button" id="btnLimpar">Limpar Assinatura</button>
      </div>
    </div>

    <div class="full">
      <label><input type="checkbox" id="fldAceite" required> Autorizo assinatura eletrônica e confirmo que li o contrato.</label>
    </div>
    <div class="full actions">
      <button type="submit" class="btn" id="btnSubmit">Gerar PDF + WhatsApp</button>
    </div>
  </form>
</main>

<div class="toast" id="toast">PDF gerado e WhatsApp aberto. Obrigado!</div>
<canvas class="confetti" id="confetti"></canvas>

<script>
(function(){
  const state = { signatureLibOk:false };
  window.addEventListener('error', (e)=>{
    console.error('[Erro global]', e.message);
  });

  function ready(fn){
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }

  ready(()=>{
    const { jsPDF } = window.jspdf || {};
    const WHATSAPP_NUMBER = '5519984278886';

    // Bind estático (independe da assinatura funcionar)
    document.getElementById('rPF').addEventListener('change', applyTipo);
    document.getElementById('rPJ').addEventListener('change', applyTipo);
    document.getElementById('fldPlano').addEventListener('change', updateValor);
    document.getElementById('fldDoc').addEventListener('input', (e)=> maskDoc(e.target));
    document.getElementById('fldFone').addEventListener('input', (e)=> maskPhone(e.target));
    document.getElementById('btnLimpar').addEventListener('click', clearSignature);
    document.getElementById('formAssinatura').addEventListener('submit', onSubmit);

    // Inicializações
    safeInitSigPad();
    applyTipo();
    updateValor();

    // Helpers
    function showToast(){ const t=document.getElementById('toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3500);}
    function getDigits(s){ return (s||'').toString().replace(/\\D+/g,''); }
    function formatPhone(value){
      let v = getDigits(value).slice(0,11);
      if(v.length <= 10){
        return v.replace(/(\\d{0,2})(\\d{0,4})(\\d{0,4}).*/, (m,a,b,c)=>{
          let out=''; if(a) out+=`(${a}`+(a.length===2?') ':'');
          if(b) out+=b; if(c) out+='-'+c; return out;
        });
      }
      return v.replace(/(\\d{2})(\\d{5})(\\d{4})/, '($1) $2-$3');
    }
    function maskPhone(i){ i.value = formatPhone(i.value); }
    function maskCPF(d){ return d.replace(/(\\d{3})(\\d{3})(\\d{3})(\\d{2})/,'$1.$2.$3-$4'); }
    function maskCNPJ(d){ return d.replace(/(\\d{2})(\\d{3})(\\d{3})(\\d{4})(\\d{2})/,'$1.$2.$3/$4-$5'); }
    function maskDoc(i){
      const isPF = document.getElementById('rPF').checked;
      let d = getDigits(i.value); d = isPF? d.slice(0,11): d.slice(0,14);
      i.value = d ? (isPF? maskCPF(d) : maskCNPJ(d)) : '';
    }
    function vCPF(v){
      const d=getDigits(v); if(d.length!==11 || /^(\\d)\\1{10}$/.test(d)) return false;
      let s=0; for(let i=0;i<9;i++) s+= +d[i]*(10-i);
      let r=(s*10)%11; if(r===10) r=0; if(r!== +d[9]) return false;
      s=0; for(let i=0;i<10;i++) s+= +d[i]*(11-i);
      r=(s*10)%11; if(r===10) r=0; return r=== +d[10];
    }
    function vCNPJ(v){
      const d=getDigits(v); if(d.length!==14 || /^(\\d)\\1{13}$/.test(d)) return false;
      const calc = (len)=>{ const f=(len===12)?[5,4,3,2,9,8,7,6,5,4,3,2]:[6,5,4,3,2,9,8,7,6,5,4,3,2]; let s=0; for(let i=0;i<f.length;i++) s+= +d[i]*f[i]; const r=s%11; return r<2?0:11-r; };
      return calc(12)=== +d[12] && calc(13)=== +d[13];
    }

    // PF/PJ + Plano
    function applyTipo(){
      const isPF = document.getElementById('rPF').checked;
      const lblDoc = document.getElementById('lblDoc');
      const fldDoc = document.getElementById('fldDoc');
      const lblRazao = document.getElementById('lblRazao');
      const fldRazao = document.getElementById('fldRazao');
      const grpResp = document.getElementById('grpResp');

      lblDoc.textContent = isPF ? 'CPF' : 'CNPJ';
      fldDoc.placeholder = isPF ? '000.000.000-00' : '00.000.000/0000-00';
      lblRazao.textContent = isPF ? 'Nome completo' : 'Razão Social';
      fldRazao.placeholder = isPF ? 'Seu nome completo' : 'Nome da Empresa LTDA';
      grpResp.style.display = isPF ? 'none' : 'block';
      document.getElementById('fldResp').required = !isPF;
      fldDoc.value = '';
    }
    function updateValor(){
      const plano = document.getElementById('fldPlano').value;
      document.getElementById('fldValor').value = plano.includes('Prime') ? 'R$ 2.000,00/mês' : 'R$ 1.500,00/mês';
    }

    // SignaturePad com proteção
    let sigPad=null, resizeTimer=null;
    function safeInitSigPad(){
      try{
        const Sig = window.SignaturePad;
        const c = document.getElementById('sigCanvas');
        const rect = c.getBoundingClientRect();
        const prev = sigPad && !sigPad.isEmpty() ? sigPad.toData() : null;
        const ratio = Math.max(window.devicePixelRatio||1,1);
        c.width = Math.floor(rect.width*ratio); c.height = Math.floor(160*ratio);
        c.style.width = rect.width + 'px'; c.style.height = '160px';
        c.getContext('2d').scale(ratio, ratio);
        if(Sig){
          if(sigPad) sigPad.off();
          sigPad = new Sig(c, { backgroundColor:'rgba(0,0,0,0)', penColor:'#000' });
          if(prev){ try{ sigPad.fromData(prev); }catch(_){ } }
          state.signatureLibOk = true;
          document.getElementById('sigWarn').style.display='none';
        }else{
          state.signatureLibOk = false;
          document.getElementById('sigWarn').style.display='block';
        }
      }catch(err){
        console.error('Falha init assinatura', err);
        state.signatureLibOk = false;
        document.getElementById('sigWarn').style.display='block';
      }
    }
    function clearSignature(){ if(sigPad){ sigPad.clear(); } }
    window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(safeInitSigPad,150); }, {passive:true});

    // Util
    function genDocId(){ const d=new Date(); const pad=n=>('0'+n).slice(-2); return 'HELP-'+d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+'-'+Math.floor(Math.random()*9000+1000); }
    function escapeHtml(str){return (str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

    async function fetchTemplate(){
      try{
        const resp = await fetch('contract-fill.html', { cache: 'no-store' });
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        return await resp.text();
      }catch(e){
        console.warn('Falha ao carregar contract-fill.html, usando template interno.', e);
        return `
        <style>.page{width:794px;height:1123px;padding:48px;box-sizing:border-box;font-family:'Open Sans',sans-serif;color:#111}</style>
        <div class="page">
          <h1 style="font-family:Montserrat,sans-serif">Contrato Help! – {{PLANO}}</h1>
          <p>ID: {{DOCID}} • {{DATETIME}}</p>
          <p><strong>Contratante:</strong> {{RAZAO}} ({{PESSOA_TIPO}}) • {{DOC_ID}}</p>
          <p><strong>E-mail:</strong> {{EMAIL}} • <strong>Fone:</strong> {{FONE}}</p>
          <p><strong>Valor:</strong> {{VALOR}} • Data: {{DATA}}</p>
          <div style="margin-top:12px">{{ASSINATURA}}</div>
        </div>`;
      }
    }

    async function buildPdf(data, assinaturaPNG, isPF){
      const tplRaw = await fetchTemplate();
      const now = new Date();
      const dataHora = now.toLocaleString('pt-BR');
      const docId = genDocId();
      const displayName = data.razao;
      const responsavel = isPF ? data.razao : (data.resp||data.razao);
      const docGeneric = data.doc;
      let pdfHtml = tplRaw.replaceAll('CNPJ','CPF/CNPJ')
        .replaceAll('{{RAZAO}}', escapeHtml(displayName))
        .replaceAll('{{RESP}}', escapeHtml(responsavel))
        .replaceAll('{{EMAIL}}', escapeHtml(data.email))
        .replaceAll('{{FONE}}', escapeHtml(data.fone))
        .replaceAll('{{PLANO}}', escapeHtml(data.plano))
        .replaceAll('{{VALOR}}', data.valorPlano)
        .replaceAll('{{DATA}}', escapeHtml(data.dataBR))
        .replaceAll('{{DATETIME}}', escapeHtml(dataHora))
        .replaceAll('{{DOCID}}', escapeHtml(docId))
        .replaceAll('{{PESSOA_TIPO}}', isPF?'Pessoa Física':'Pessoa Jurídica')
        .replaceAll('{{CNPJ}}', escapeHtml(docGeneric))
        .replaceAll('{{CPF}}', escapeHtml(docGeneric))
        .replaceAll('{{DOC_ID}}', escapeHtml(docGeneric))
        .replaceAll('{{ASSINATURA}}', '<img src=\"'+assinaturaPNG+'\" alt=\"Assinatura\" style=\"height:80px\">');
      const holder = document.createElement('div');
      holder.style.position='fixed'; holder.style.left='-200vw'; holder.style.top='0'; holder.style.width='794px';
      holder.innerHTML = pdfHtml; document.body.appendChild(holder);
      const pdf = new (window.jspdf&&window.jspdf.jsPDF? window.jspdf.jsPDF : jsPDF)({ unit:'pt', format:'a4', putOnlyUsedFonts:true });
      const nodes = holder.querySelectorAll('.page');
      for(let i=0;i<nodes.length;i++){
        const canvas = await html2canvas(nodes[i], { scale:2, backgroundColor:'#ffffff', useCORS:true, allowTaint:false });
        const img = canvas.toDataURL('image/png');
        pdf.addImage(img, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
        if(i<nodes.length-1) pdf.addPage();
      }
      document.body.removeChild(holder);
      return { pdf, docId, dataHora };
    }

    function collectData(){
      const isPF = document.getElementById('rPF').checked;
      const plano = document.getElementById('fldPlano').value;
      const data = new Date();
      return {
        isPF, plano,
        doc: document.getElementById('fldDoc').value.trim(),
        razao: document.getElementById('fldRazao').value.trim(),
        resp: document.getElementById('fldResp').value.trim(),
        email: document.getElementById('fldEmail').value.trim(),
        fone: document.getElementById('fldFone').value.trim(),
        aceite: document.getElementById('fldAceite').checked,
        dataBR: data.toLocaleDateString('pt-BR'),
        valorPlano: document.getElementById('fldValor').value
      };
    }

    async function onSubmit(e){
      e.preventDefault();
      const btn = document.getElementById('btnSubmit');
      btn.disabled=true; const original=btn.textContent; btn.textContent='Gerando...';
      try{
        const d = collectData();
        const okDoc = d.isPF ? vCPF(d.doc) : vCNPJ(d.doc);
        if(!okDoc){ alert(d.isPF?'CPF inválido.':'CNPJ inválido.'); return; }
        if(!(d.doc && d.razao && d.email && d.fone && d.aceite)){ alert('Preencha todos os campos obrigatórios e marque o aceite.'); return; }
        if(!d.isPF && !d.resp){ alert('Informe o responsável (PJ).'); return; }
        if(!state.signatureLibOk){ alert('A biblioteca de assinatura não foi carregada. Verifique sua conexão/bloqueadores e recarregue a página.'); return; }
        if(!window.sigPad || sigPad.isEmpty()){ alert('Por favor, assine no campo de assinatura.'); return; }
        const assinaturaPNG = sigPad.toDataURL('image/png');
        const built = await buildPdf(d, assinaturaPNG, d.isPF);
        const { pdf, docId, dataHora } = built;
        const nameBase = d.razao.replace(/\\s+/g,'_');
        const fileName = 'Contrato_' + nameBase + '_' + docId + '.pdf';
        pdf.save(fileName);
        const rotDoc = d.isPF ? 'CPF' : 'CNPJ';
        const resumo = 'Proposta Help!%0APlano: ' + encodeURIComponent(d.plano)
          + '%0AValor: ' + encodeURIComponent(d.valorPlano)
          + '%0A' + rotDoc + ': ' + encodeURIComponent(d.doc)
          + '%0ANome/Razão: ' + encodeURIComponent(d.razao)
          + (d.isPF ? '' : '%0AResponsável: ' + encodeURIComponent(d.resp||''))
          + '%0AE-mail: ' + encodeURIComponent(d.email)
          + '%0AFone: ' + encodeURIComponent(d.fone)
          + '%0AData/Hora: ' + encodeURIComponent(dataHora)
          + '%0AID: ' + encodeURIComponent(docId);
        window.open('https://wa.me/' + WHATSAPP_NUMBER + '?text=' + resumo, '_blank');
        showToast(); shootConfetti();
      }catch(err){
        console.error('Erro ao gerar', err);
        alert('Não foi possível gerar o PDF. Verifique o console do navegador (F12 > Console) para detalhes.');
      }finally{
        btn.disabled=false; btn.textContent=original;
      }
    }

    function shootConfetti(){
      const c = document.getElementById('confetti'); const ctx = c.getContext('2d');
      c.style.display='block'; c.width=innerWidth; c.height=innerHeight;
      const pieces = Array.from({length:140}, ()=>({x:Math.random()*c.width,y:-20, r: 4+Math.random()*6, vy: 2+Math.random()*3, vx:(Math.random()-.5)*2, a: Math.random()*Math.PI}));
      let t=0;
      (function draw(){ ctx.clearRect(0,0,c.width,c.height); pieces.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; p.a+=.05; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); }); if(t++<150) requestAnimationFrame(draw); else c.style.display='none'; })();
    }

  }); // ready
})();</script>
</body>
</html>
