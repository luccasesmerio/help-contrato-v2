<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assinatura do Contrato | Help!</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --brand:#FFC107; --dark:#000; --light:#fff; --muted:#666; --border:#e5e5e5; --radius:14px; }
    *{box-sizing:border-box}
    body{margin:0;font:500 16px/1.6 'Open Sans',ui-sans-serif;color:#111;background:#fff}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:900px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:30px;height:30px;border-radius:8px;object-fit:cover}
    .grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    .full{grid-column:1/-1}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border)}
    label{font-size:13px;color:#444}
    .card{border:1px solid var(--border);padding:16px;border-radius:var(--radius)}
    .btn{border:0;background:linear-gradient(180deg,#FFD54F,#FFC107);color:#000;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;font-family:'Montserrat',sans-serif;box-shadow:0 6px 18px rgba(255,193,7,.25)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    canvas{display:block;width:100%;height:160px;background:#f8f8f8;border:1px dashed #ccc;border-radius:10px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.3s}
    .toast.show{opacity:1;transform:none}
    .confetti{position:fixed;inset:0;pointer-events:none;display:none}
    .inline{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:#666}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">
      <img src="https://i.imgur.com/HzfBxmz.png" alt="Help!">
      <div><strong style="font-family:'Montserrat',sans-serif">Help! – Assinatura</strong><div style="font-size:12px;color:#666">Preencha seus dados e assine abaixo</div></div>
    </div>
    <button class="btn" type="button" onclick="location.href='contract.html'">Ler Contrato</button>
  </div>
</header>

<main class="container">
  <form class="grid" id="formAssinatura" novalidate>
    <!-- Tipo de Pessoa -->
    <div class="full">
      <label>Tipo de contratante</label>
      <div class="inline">
        <label><input type="radio" name="tipo" value="PF" id="rPF" checked> Pessoa Física (CPF)</label>
        <label><input type="radio" name="tipo" value="PJ" id="rPJ"> Pessoa Jurídica (CNPJ)</label>
        <span class="muted" id="hintTipo">• Campos ajustam automaticamente</span>
      </div>
    </div>

    <div>
      <label>Plano</label>
      <select id="fldPlano">
        <option>Help! Start</option>
        <option selected>Help! Prime</option>
      </select>
    </div>
    <div>
      <label>Valor</label>
      <input id="fldValor" value="R$ 2.000,00/mês" readonly />
    </div>

    <!-- Documento -->
    <div>
      <label id="lblDoc">CPF</label>
      <input id="fldDoc" required placeholder="000.000.000-00" />
    </div>

    <!-- Nome / Razão -->
    <div class="full">
      <label id="lblRazao">Nome completo</label>
      <input id="fldRazao" required placeholder="Seu nome completo"/>
    </div>

    <!-- Responsável (apenas PJ) -->
    <div id="grpResp" style="display:none">
      <label id="lblResp">Responsável</label>
      <input id="fldResp" placeholder="Nome do responsável legal"/>
    </div>

    <div>
      <label>E-mail</label>
      <input id="fldEmail" type="email" required placeholder="contato@empresa.com"/>
    </div>
    <div class="full">
      <label>Telefone/WhatsApp</label>
      <input id="fldFone" required placeholder="(00) 00000-0000" />
    </div>

    <!-- Assinatura -->
    <div class="full card">
      <label>Assinatura (desenhe abaixo)</label>
      <canvas id="sigCanvas"></canvas>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" type="button" id="btnLimpar">Limpar Assinatura</button>
      </div>
    </div>

    <div class="full">
      <label><input type="checkbox" id="fldAceite" required> Autorizo assinatura eletrônica e confirmo que li o contrato.</label>
    </div>
    <div class="full actions">
      <button type="submit" class="btn" id="btnSubmit">Gerar PDF + WhatsApp</button>
    </div>
  </form>
</main>

<div class="toast" id="toast">PDF gerado e WhatsApp aberto. Obrigado!</div>
<canvas class="confetti" id="confetti"></canvas>

<script>
  // libs
  const { jsPDF } = window.jspdf;
  let sigPad;

  // ---------- Assinatura ----------
  function initSigPad() {
    const c = document.getElementById('sigCanvas');
    const rect = c.getBoundingClientRect();
    const prev = sigPad && !sigPad.isEmpty() ? sigPad.toData() : null;
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    c.width = Math.floor(rect.width * ratio);
    c.height = Math.floor(160 * ratio);
    c.style.width = rect.width + 'px';
    c.style.height = '160px';
    const ctx = c.getContext('2d');
    ctx.scale(ratio, ratio);
    if (sigPad && sigPad.off) sigPad.off();
    if (typeof SignaturePad !== 'function') {
      alert('Biblioteca de assinatura não carregou. Verifique sua conexão.');
      return;
    }
    sigPad = new SignaturePad(c, { backgroundColor: 'rgba(0,0,0,0)', penColor:'#000' });
    if (prev) { try { sigPad.fromData(prev); } catch(_){} }
  }
  window.addEventListener('load', ()=>{ initSigPad(); applyTipo(); updateValor(); });
  let resizeTimer; window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(initSigPad,150); });
  document.getElementById('btnLimpar').addEventListener('click', ()=> sigPad && sigPad.clear());

  // ---------- Máscaras/validações ----------
  const getDigits = s => (s||'').toString().replace(/\D+/g,'');
  function maskPhone(i) {
    let v = getDigits(i.value).slice(0,11);
    i.value = v.length<=10
      ? v.replace(/(\d{0,2})(\d{0,4})(\d{0,4}).*/, (_,$1,$2,$3)=> {
          let out=''; if($1) out += `(${ $1 }` + ($1.length===2?') ':'' );
          if($2) out += $2; if($3) out += `-${$3}`; return out;
        })
      : v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
  }
  function maskCPF(d){ return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4'); }
  function maskCNPJ(d){ return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5'); }
  function maskDoc(i){
    const isPF = document.getElementById('rPF').checked;
    let d = getDigits(i.value);
    d = isPF ? d.slice(0,11) : d.slice(0,14);
    i.value = d ? (isPF ? maskCPF(d) : maskCNPJ(d)) : '';
  }
  function vCPF(v){
    const d=getDigits(v); if(d.length!==11 || /^(\d)\1{10}$/.test(d)) return false;
    let s=0; for(let i=0;i<9;i++) s+= +d[i]*(10-i);
    let r=(s*10)%11; if(r===10) r=0; if(r!== +d[9]) return false;
    s=0; for(let i=0;i<10;i++) s+= +d[i]*(11-i);
    r=(s*10)%11; if(r===10) r=0; return r=== +d[10];
  }
  function vCNPJ(v){
    const d=getDigits(v); if(d.length!==14 || /^(\d)\1{13}$/.test(d)) return false;
    const calc = (len) => {
      const f = (len===12)?[5,4,3,2,9,8,7,6,5,4,3,2]:[6,5,4,3,2,9,8,7,6,5,4,3,2];
      let s=0; for(let i=0;i<f.length;i++) s+= +d[i]*f[i];
      const r=s%11; return r<2?0:11-r;
    };
    return calc(12)=== +d[12] && calc(13)=== +d[13];
  }

  // ---------- PF/PJ ----------
  function applyTipo(){
    const isPF = document.getElementById('rPF').checked;
    document.getElementById('lblDoc').textContent = isPF ? 'CPF' : 'CNPJ';
    document.getElementById('fldDoc').placeholder = isPF ? '000.000.000-00' : '00.000.000/0000-00';
    document.getElementById('lblRazao').textContent = isPF ? 'Nome completo' : 'Razão Social';
    document.getElementById('fldRazao').placeholder = isPF ? 'Seu nome completo' : 'Nome da Empresa LTDA';
    document.getElementById('grpResp').style.display = isPF ? 'none' : 'block';
    document.getElementById('fldResp').required = !isPF;
    document.getElementById('fldDoc').value = '';
  }
  document.getElementById('rPF').addEventListener('change', applyTipo);
  document.getElementById('rPJ').addEventListener('change', applyTipo);

  // ---------- Plano ----------
  function updateValor() {
    const plano = document.getElementById('fldPlano').value;
    document.getElementById('fldValor').value = plano.includes('Prime') ? 'R$ 2.000,00/mês' : 'R$ 1.500,00/mês';
  }
  document.getElementById('fldPlano').addEventListener('change', updateValor);

  // ---------- Utils ----------
  function genDocId() {
    const d = new Date();
    const pad = n=>('0'+n).slice(-2);
    return 'HELP-' + d.getFullYear() + pad(d.getMonth()+1) + pad(d.getDate()) + '-' + Math.floor(Math.random()*9000+1000);
  }
  function escapeHtml(str){return (str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

  // ---------- Template ----------
  const INTERNAL_TEMPLATE = `
    <style>
      .page{width:794px;height:1123px;padding:48px;box-sizing:border-box;font-family:'Open Sans',sans-serif;color:#111; position:relative}
      h1{font-family:'Montserrat',sans-serif; font-size:22px; margin:0 0 12px}
      .muted{color:#666}
      .foot{position:absolute;bottom:18pt;left:48px;right:48px;font-size:11px;color:#666;display:flex;justify-content:space-between}
      .foot .id{font-weight:600}
    </style>
    <div class="page">
      <h1>Contrato Help! – {{PLANO}}</h1>
      <p class="muted">ID: {{DOCID}} • {{DATETIME}}</p>
      <p><strong>Contratante:</strong> {{RAZAO}} ({{PESSOA_TIPO}}) • CPF/CNPJ {{DOC_ID}}</p>
      <p><strong>E-mail:</strong> {{EMAIL}} • <strong>Fone:</strong> {{FONE}}</p>
      <p><strong>Valor:</strong> {{VALOR}} • Data: {{DATA}}</p>
      <div style="margin-top:18px"><strong>Assinatura:</strong><br>{{ASSINATURA}}</div>
      <div class="foot">
        <div class="id">ID: {{DOCID}}</div>
        <div>{{RAZAO}} • {{DATETIME}}</div>
        <div>Página 1/1</div>
      </div>
    </div>`;

  async function fetchTemplate(){
    try{
      const resp = await fetch('contract-fill.html', { cache: 'no-store' });
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      return await resp.text();
    }catch(_){
      return INTERNAL_TEMPLATE; // fallback garante .page
    }
  }

  // ---------- PDF ----------
  async function buildPdf(data, assinaturaPNG, isPF) {
    let tpl = await fetchTemplate();
    const now = new Date();
    const dataHora = now.toLocaleString('pt-BR');
    const docId = genDocId();
    const displayName = data.razao;
    const responsavel  = isPF ? data.razao : (data.resp||data.razao);
    const docGeneric   = data.doc;

    const pdfHtml = tpl
      .replaceAll('{{RAZAO}}', escapeHtml(displayName))
      .replaceAll('{{RESP}}', escapeHtml(responsavel))
      .replaceAll('{{EMAIL}}', escapeHtml(data.email))
      .replaceAll('{{FONE}}', escapeHtml(data.fone))
      .replaceAll('{{PLANO}}', escapeHtml(data.plano))
      .replaceAll('{{VALOR}}', data.valorPlano)
      .replaceAll('{{DATA}}', escapeHtml(data.dataBR))
      .replaceAll('{{DATETIME}}', escapeHtml(dataHora))
      .replaceAll('{{DOCID}}', escapeHtml(docId))
      .replaceAll('{{PESSOA_TIPO}}', isPF ? 'Pessoa Física' : 'Pessoa Jurídica')
      .replaceAll('{{CNPJ}}', escapeHtml(docGeneric))
      .replaceAll('{{CPF}}',  escapeHtml(docGeneric))
      .replaceAll('{{DOC_ID}}',escapeHtml(docGeneric))
      .replaceAll('{{ASSINATURA}}', '<img src="' + assinaturaPNG + '" alt="Assinatura" style="height:80px">');

    const holder = document.createElement('div');
    holder.style.position = 'fixed'; holder.style.left='-200vw'; holder.style.top='0';
    holder.style.width='794px';
    holder.innerHTML = pdfHtml;
    document.body.appendChild(holder);

    const pdf = new jsPDF({ unit:'pt', format:'a4', putOnlyUsedFonts:true });
    const nodes = holder.querySelectorAll('.page');
    for(let i=0;i<nodes.length;i++) {
      const canvas = await html2canvas(nodes[i], { scale:2, backgroundColor:'#ffffff', useCORS:true, allowTaint:false });
      const img = canvas.toDataURL('image/png');
      pdf.addImage(img, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
      if(i < nodes.length-1) pdf.addPage();
    }
    document.body.removeChild(holder);
    return { pdf, docId, dataHora };
  }

  // ---------- Coleta ----------
  function collectData() {
    const isPF = document.getElementById('rPF').checked;
    const plano = document.getElementById('fldPlano').value;
    const data = new Date();
    return {
      isPF,
      plano,
      doc: document.getElementById('fldDoc').value.trim(),
      razao: document.getElementById('fldRazao').value.trim(),
      resp: document.getElementById('fldResp').value.trim(),
      email: document.getElementById('fldEmail').value.trim(),
      fone: document.getElementById('fldFone').value.trim(),
      aceite: document.getElementById('fldAceite').checked,
      dataBR: data.toLocaleDateString('pt-BR'),
      valorPlano: document.getElementById('fldValor').value
    };
  }

  // ---------- UI ----------
  function showToast(){ const t=document.getElementById('toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3500);}
  function shootConfetti() {
    const c = document.getElementById('confetti'); const ctx = c.getContext('2d');
    c.style.display='block'; c.width=innerWidth; c.height=innerHeight;
    const pieces = Array.from({length:140}, ()=>({x:Math.random()*c.width,y:-20, r: 4+Math.random()*6, vy: 2+Math.random()*3, vx:(Math.random()-.5)*2, a: Math.random()*Math.PI}));
    let t=0;
    (function draw(){ ctx.clearRect(0,0,c.width,c.height); pieces.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; p.a+=.05; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle = ['#FFC107','#000','#2C2C2C','#F5F5F5'][Math.floor(Math.random()*4)]; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); }); if(t++<150) requestAnimationFrame(draw); else c.style.display='none'; })();
  }

  // ---------- Eventos ----------
  document.getElementById('fldDoc').addEventListener('input', (e)=> maskDoc(e.target));
  document.getElementById('fldFone').addEventListener('input', (e)=> maskPhone(e.target));

  document.getElementById('formAssinatura').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.currentTarget;

    // 1) validação nativa
    if (typeof form.reportValidity === 'function' && !form.reportValidity()) return;

    // 2) validações custom
    const d = collectData();
    const okDoc = d.isPF ? vCPF(d.doc) : vCNPJ(d.doc);
    if(!okDoc){ alert(d.isPF ? 'CPF inválido.' : 'CNPJ inválido.'); return; }
    if(!d.isPF && !d.resp){ alert('Informe o responsável (PJ).'); return; }
    if(!sigPad || sigPad.isEmpty()) { alert('Por favor, assine no campo de assinatura.'); return; }

    // 3) feedback de processo
    const btn = document.getElementById('btnSubmit');
    btn.disabled = true; const originalText = btn.textContent; btn.textContent = 'Gerando...';

    // 4) abre aba antes (reduz bloqueio), segura redirecionamento até concluir PDF
    let waWin = null;
    try { waWin = window.open('about:blank', '_blank'); } catch(_) {}

    try{
      const assinaturaPNG = sigPad.toDataURL('image/png'); // síncrono
      const { pdf, docId, dataHora } = await buildPdf(d, assinaturaPNG, d.isPF);

      const fileName = 'Contrato_' + d.razao.replace(/\s+/g,'_') + '_' + docId + '.pdf';
      pdf.save(fileName); // jsPDF v2.x não retorna Promise

      const rotDoc = d.isPF ? 'CPF' : 'CNPJ';
      const resumo = [
        'Proposta Help!',
        'Plano: ' + d.plano,
        'Valor: ' + d.valorPlano,
        rotDoc + ': ' + d.doc,
        'Nome/Razão: ' + d.razao,
        (d.isPF ? null : 'Responsável: ' + (d.resp||'')),
        'E-mail: ' + d.email,
        'Fone: ' + d.fone,
        'Data/Hora: ' + dataHora,
        'ID: ' + docId
      ].filter(Boolean).join('\n'); // << correção: \n (sem %0A)

      const WHATSAPP_NUMBER = '5519984278886'; // ajuste
      const waUrl = 'https://wa.me/' + WHATSAPP_NUMBER + '?text=' + encodeURIComponent(resumo);

      // dá um fôlego pro download iniciar antes de redirecionar
      setTimeout(()=>{
        if (waWin && !waWin.closed) {
          waWin.location.href = waUrl;
        } else {
          window.location.href = waUrl; // fallback se popup for bloqueado
        }
      }, 600);

      showToast();
      shootConfetti();
    }catch(err){
      console.error(err);
      alert('Não foi possível gerar o PDF. Veja o console.');
      if (waWin && !waWin.closed) waWin.close(); // evita aba em branco
    }finally{
      btn.disabled = false; btn.textContent = originalText;
    }
  });
</script>
</body>
</html>
